{% extends 'base.html' %}

{% block content %}
<div class="calendar-page">
    <div class="calendar-layout">
        <!-- Левая колонка - Календарь -->
        <div class="calendar-left">
            <div class="calendar-container" id="calendarContainer">
                <div class="calendar-loading">
                    <i class="ri-loader-4-line"></i>
                    <p>Загрузка...</p>
                </div>
            </div>
        </div>
        
        <!-- Правая колонка - Задачи -->
        <div class="calendar-right">
            <div class="calendar-tasks-panel" id="tasksPanel">
                <div class="tasks-panel-header">
                    <h2 class="tasks-panel-title" id="tasksPanelTitle">Выберите дату</h2>
                    <span class="tasks-panel-count" id="tasksPanelCount"></span>
                </div>
                <div class="tasks-panel-body" id="tasksPanelBody">
                    <div class="tasks-panel-empty">
                        <i class="ri-calendar-check-line"></i>
                        <p>Нажмите на день в календаре</p>
                    </div>
                </div>
            </div>
            
            <!-- Предстоящие задачи -->
            <div class="upcoming-tasks" id="upcomingTasks">
                <div class="tasks-panel-header">
                    <h3 class="tasks-panel-subtitle">
                        <i class="ri-time-line"></i>
                        Предстоящие
                    </h3>
                </div>
                <div class="tasks-panel-body" id="upcomingTasksBody">
                    <!-- Заполняется JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-page {
    height: calc(100vh - var(--header-height) - 48px);
}

.calendar-layout {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 24px;
    height: 100%;
}

.calendar-left {
    display: flex;
    flex-direction: column;
}

.calendar-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 20px;
    height: fit-content;
}

.calendar-right {
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow: hidden;
}

.calendar-tasks-panel {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 300px;
}

.upcoming-tasks {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    max-height: 250px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.tasks-panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}

.tasks-panel-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.date-today-badge {
    background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-primary-hover) 100%);
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.tasks-panel-subtitle {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tasks-panel-count {
    font-size: 13px;
    color: var(--text-muted);
    background: var(--bg-elevated);
    padding: 2px 10px;
    border-radius: 10px;
}

.tasks-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
}

.tasks-panel-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    color: var(--text-muted);
    text-align: center;
    gap: 12px;
}

.tasks-panel-empty i {
    font-size: 48px;
    opacity: 0.5;
}

/* Task cards for calendar */
.calendar-task-card {
    display: flex;
    gap: 12px;
    padding: 12px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    margin-bottom: 8px;
    transition: all var(--transition-fast);
    text-decoration: none;
    border-left: 3px solid var(--task-color, var(--accent-primary));
}

.calendar-task-card:hover {
    background: var(--bg-elevated);
    transform: translateX(4px);
}

.calendar-task-card.completed {
    opacity: 0.6;
}

.calendar-task-card.completed .calendar-task-title {
    text-decoration: line-through;
}

.calendar-task-checkbox {
    flex-shrink: 0;
    margin-top: 2px;
}

.calendar-task-content {
    flex: 1;
    min-width: 0;
}

.calendar-task-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 4px;
    display: block;
}

.calendar-task-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 12px;
    color: var(--text-muted);
}

.calendar-task-meta span {
    display: flex;
    align-items: center;
    gap: 4px;
}

.calendar-task-project {
    font-weight: 500;
}

.calendar-task-time {
    color: var(--text-secondary);
}

.calendar-task-priority {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 6px;
}

.calendar-task-desc {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 6px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Overdue indicator */
.task-overdue {
    color: var(--priority-urgent) !important;
}

.task-today {
    color: var(--accent-secondary) !important;
}

/* Calendar loading */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.calendar-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-muted);
    gap: 12px;
}

.calendar-loading i {
    font-size: 28px;
    animation: spin 1s linear infinite;
}

/* Responsive */
@media (max-width: 900px) {
    .calendar-layout {
        grid-template-columns: 1fr;
    }
    
    .calendar-page {
        height: auto;
    }
    
    .calendar-tasks-panel {
        min-height: 400px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Full calendar class for the calendar page
class CalendarView {
    constructor(container) {
        this.container = container;
        this.currentDate = new Date();
        this.selectedDate = this.getTodayStr();
        this.events = [];
        
        this.init();
    }
    
    formatDateStr(year, month, day) {
        const m = String(month + 1).padStart(2, '0');
        const d = String(day).padStart(2, '0');
        return `${year}-${m}-${d}`;
    }
    
    getTodayStr() {
        const today = new Date();
        return this.formatDateStr(today.getFullYear(), today.getMonth(), today.getDate());
    }
    
    async init() {
        await this.loadEvents();
        this.render();
    }
    
    async loadEvents() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        const start = this.formatDateStr(year, month, 1);
        const lastDay = new Date(year, month + 1, 0).getDate();
        const end = this.formatDateStr(year, month, lastDay);
        
        try {
            const response = await fetch(`/api/calendar-events/?start=${start}&end=${end}`);
            this.events = await response.json();
        } catch (error) {
            console.error('Error loading calendar events:', error);
            this.events = [];
        }
    }
    
    render() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        const monthNames = [
            'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
            'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
        ];
        
        const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        let startDay = firstDay.getDay();
        startDay = startDay === 0 ? 6 : startDay - 1;
        
        const todayStr = this.getTodayStr();
        
        let html = `
            <div class="calendar-header">
                <h2 class="calendar-title">${monthNames[month]} ${year}</h2>
                <div class="calendar-nav">
                    <button class="btn-icon" onclick="calendar.prevMonth()">
                        <i class="ri-arrow-left-s-line"></i>
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="calendar.goToToday()">Сегодня</button>
                    <button class="btn-icon" onclick="calendar.nextMonth()">
                        <i class="ri-arrow-right-s-line"></i>
                    </button>
                </div>
            </div>
            <div class="calendar-grid">
        `;
        
        // Day headers
        dayNames.forEach(day => {
            html += `<div class="calendar-day-header">${day}</div>`;
        });
        
        // Previous month days
        const prevMonthLastDay = new Date(year, month, 0);
        for (let i = startDay - 1; i >= 0; i--) {
            const day = prevMonthLastDay.getDate() - i;
            html += `<div class="calendar-day other-month"><span class="calendar-day-number">${day}</span></div>`;
        }
        
        // Current month days
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = this.formatDateStr(year, month, day);
            const isToday = dateStr === todayStr;
            const isSelected = dateStr === this.selectedDate;
            const dayEvents = this.events.filter(e => e.start === dateStr);
            
            let dayClass = 'calendar-day';
            if (isToday) dayClass += ' today';
            if (isSelected) dayClass += ' selected';
            if (dayEvents.length > 0) dayClass += ' has-events';
            
            html += `
                <div class="${dayClass}" onclick="calendar.selectDate('${dateStr}')">
                    <span class="calendar-day-number">${day}</span>
                    ${dayEvents.length > 0 ? `
                        <div class="calendar-day-tasks">
                            ${dayEvents.slice(0, 3).map(e => `<span class="calendar-day-dot" style="background: ${e.color}"></span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Next month days
        const totalCells = startDay + lastDay.getDate();
        const rows = Math.ceil(totalCells / 7);
        const remainingCells = (rows * 7) - totalCells;
        for (let day = 1; day <= remainingCells; day++) {
            html += `<div class="calendar-day other-month"><span class="calendar-day-number">${day}</span></div>`;
        }
        
        html += '</div>';
        
        this.container.innerHTML = html;
        
        // Update side panel
        this.updateTasksPanel();
        this.updateUpcomingTasks();
    }
    
    updateTasksPanel() {
        const todayStr = this.getTodayStr();
        const selectedDateStr = this.selectedDate || todayStr;
        const selectedEvents = this.events.filter(e => e.start === selectedDateStr);
        
        // Update title
        const titleEl = document.getElementById('tasksPanelTitle');
        const countEl = document.getElementById('tasksPanelCount');
        const bodyEl = document.getElementById('tasksPanelBody');
        
        if (titleEl) {
            const fullDate = this.formatFullDate(selectedDateStr);
            if (selectedDateStr === todayStr) {
                titleEl.innerHTML = `<span class="date-today-badge">Сегодня</span> ${fullDate}`;
            } else {
                titleEl.textContent = fullDate;
            }
        }
        
        if (countEl) {
            if (selectedEvents.length > 0) {
                countEl.textContent = `${selectedEvents.length} ${this.pluralize(selectedEvents.length, 'задача', 'задачи', 'задач')}`;
            } else {
                countEl.textContent = '';
            }
        }
        
        if (bodyEl) {
            if (selectedEvents.length > 0) {
                bodyEl.innerHTML = selectedEvents.map(e => this.renderTaskCard(e)).join('');
            } else {
                bodyEl.innerHTML = `
                    <div class="tasks-panel-empty">
                        <i class="ri-checkbox-circle-line"></i>
                        <p>Нет задач на этот день</p>
                        <button class="btn btn-primary btn-sm" onclick="openTaskModal()">
                            <i class="ri-add-line"></i> Добавить
                        </button>
                    </div>
                `;
            }
        }
    }
    
    formatFullDate(dateStr) {
        const [year, month, day] = dateStr.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
        const monthNames = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
                           'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
        return `${dayNames[date.getDay()]}, ${day} ${monthNames[month - 1]}`;
    }
    
    pluralize(n, one, few, many) {
        const mod10 = n % 10;
        const mod100 = n % 100;
        if (mod100 >= 11 && mod100 <= 19) return many;
        if (mod10 === 1) return one;
        if (mod10 >= 2 && mod10 <= 4) return few;
        return many;
    }
    
    updateUpcomingTasks() {
        const bodyEl = document.getElementById('upcomingTasksBody');
        if (!bodyEl) return;
        
        const todayStr = this.getTodayStr();
        const upcoming = this.events
            .filter(e => e.start >= todayStr && !e.completed)
            .sort((a, b) => a.start.localeCompare(b.start))
            .slice(0, 5);
        
        if (upcoming.length > 0) {
            bodyEl.innerHTML = upcoming.map(e => this.renderTaskCard(e, true)).join('');
        } else {
            bodyEl.innerHTML = '<p style="padding: 16px; color: var(--text-muted); text-align: center;">Нет предстоящих задач</p>';
        }
    }
    
    renderTaskCard(task, showDate = false) {
        const priorityColors = {
            1: 'var(--priority-low)',
            2: 'var(--priority-medium)',
            3: 'var(--priority-high)',
            4: 'var(--priority-urgent)'
        };
        
        const todayStr = this.getTodayStr();
        let dateLabel = '';
        if (showDate) {
            if (task.start === todayStr) {
                dateLabel = '<span class="task-today">Сегодня</span>';
            } else if (task.start < todayStr) {
                dateLabel = `<span class="task-overdue">Просрочено</span>`;
            } else {
                dateLabel = `<span>${this.formatDisplayDate(task.start)}</span>`;
            }
        }
        
        return `
            <a href="${task.url}" class="calendar-task-card ${task.completed ? 'completed' : ''}" style="--task-color: ${task.color}">
                <div class="calendar-task-priority" style="background: ${task.color}"></div>
                <div class="calendar-task-content">
                    <span class="calendar-task-title">${escapeHtml(task.title)}</span>
                    <div class="calendar-task-meta">
                        ${task.time ? `<span class="calendar-task-time"><i class="ri-time-line"></i> ${task.time}</span>` : ''}
                        ${task.project ? `<span class="calendar-task-project" style="color: ${task.projectColor || 'var(--accent-secondary)'}">${escapeHtml(task.project)}</span>` : ''}
                        ${dateLabel}
                    </div>
                    ${task.description ? `<p class="calendar-task-desc">${escapeHtml(task.description)}</p>` : ''}
                </div>
            </a>
        `;
    }
    
    selectDate(dateStr) {
        this.selectedDate = dateStr;
        
        // Update selection visually
        this.container.querySelectorAll('.calendar-day').forEach(day => {
            day.classList.remove('selected');
            // Find the day with matching date
            const onclick = day.getAttribute('onclick');
            if (onclick && onclick.includes(`'${dateStr}'`)) {
                day.classList.add('selected');
            }
        });
        
        this.updateTasksPanel();
    }
    
    // Переопределяем методы навигации чтобы обновлять панель
    prevMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
        this.init();
    }
    
    nextMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
        this.init();
    }
    
    goToToday() {
        this.currentDate = new Date();
        this.selectedDate = this.getTodayStr();
        this.init();
    }
    
    formatDisplayDate(dateStr) {
        const [year, month, day] = dateStr.split('-').map(Number);
        const months = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
                       'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
        return `${day} ${months[month - 1]}`;
    }
}

// Initialize calendar
document.addEventListener('DOMContentLoaded', () => {
    const calendarContainer = document.getElementById('calendarContainer');
    if (calendarContainer) {
        window.calendar = new CalendarView(calendarContainer);
    }
});

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
